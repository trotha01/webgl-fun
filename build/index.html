<!DOCTYPE HTML>
<html>
  <head>
    <title>WebGL Fun</title>
    <meta charset='utf-8'/>
    <link rel='stylesheet' href='style.css' type='text/css'>
    <script src="utility.js"></script>
    <script src="gl-matrix-min.js"></script>
    <script src="noise3D.js"></script>
    <!-- script type='text/javascript' src='../elm.js'></script -->
  </head>

  <body>
    <div id="elm"></div>
    <!--
    <canvas id="game-canvas" height=400 width=400>Your browser does not seem to support
      HTML5 canvas.</canvas>
    -->

    <canvas id="transform-feedback" height=400 width=400>Your browser does not seem to support
      HTML5 canvas.</canvas>

    <script>
/*
var app = Elm.Main.init({
        node: document.getElementById('elm')
      });

      app.ports.runGL.subscribe(function(data) {
        console.log('runGL')
      })
 */
    </script>
    <!--
    <script type='text/javascript' src='gl.js'></script>
    <script type='text/javascript' src='game.js'></script>
    -->

    <!-- WebGL 2 shaders -->
    <script id="vs-calc" type="x-shader/x-vertex">
        #version 300 es
        #define POSITION_LOCATION 0
        #define VELOCITY_LOCATION 1
        #define SPAWNTIME_LOCATION 2
        #define LIFETIME_LOCATION 3
        #define ID_LOCATION 4

        precision highp float;
        precision highp int;
        precision highp sampler3D;

        uniform float u_time;
        uniform sampler2D texFramebuffer;

        layout(location = POSITION_LOCATION) in vec2 a_position;
        layout(location = VELOCITY_LOCATION) in vec2 a_velocity;
        layout(location = SPAWNTIME_LOCATION) in float a_spawntime;
        layout(location = LIFETIME_LOCATION) in float a_lifetime;
        layout(location = ID_LOCATION) in float a_ID;

        out vec2 v_position;
        out vec2 v_velocity;
        out float v_spawntime;
        flat out vec4 vcolor;

        vec4 forceField;

        float rand(vec2 co){
            return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
        }

        vec2 walls(vec2 position, vec2 velocity) {
          if (position.x >= 1.0 || position.x <= -1.0) {
            return vec2(-velocity.x, velocity.y);
          }
          if (position.y >= 1.0 || position.y <= -1.0) {
            return vec2(velocity.x, -velocity.y);
          }
          return velocity;
        }

        void main()
        {
            if (a_spawntime == 0.0) {
                // Generate a new particle
                v_position = vec2(0.0, 0.0);
                v_velocity = vec2(rand(vec2(a_ID, 0.0)) - 0.5, rand(vec2(a_ID, a_ID)));
                v_spawntime = u_time;
                vcolor = vec4(0.0, 1.0, 1.0, 1.0);
            } else {
                v_velocity = walls(a_position, a_velocity);
                v_position = a_position + 0.01 * v_velocity;

                forceField = texture(texFramebuffer, v_position);

                v_spawntime = a_spawntime;
                vcolor = vec4(0.0, 1.0, 1.0, 1.0);
            }

            gl_Position = vec4(v_position, 0.0, 1.0);
            gl_PointSize = 2.0;
        }
    </script>

    <script id="fs-calc" type="x-shader/x-fragment">
        #version 300 es
        precision highp float;
        precision highp int;

        #define POSITION_LOCATION 0

        // uniform vec4 u_color;
        flat in vec4 vcolor;

        out vec4 color;

        void main()
        {
            color = vcolor;
        }
    </script>

    <script id="vs-draw" type="x-shader/x-vertex">
        #version 300 es
        #define POSITION_LOCATION 0

        precision highp float;
        precision highp int;
        precision highp sampler3D;

        layout(location = POSITION_LOCATION) in vec2 a_position;

        out vec2 v_position;
        flat out vec4 vcolor;

        void main()
        {
          v_position = a_position;
          vcolor = vec4(0.0, 1.0, 1.0, 1.0);

          gl_Position = vec4(v_position, 0.0, 1.0);
          gl_PointSize = 2.0;
        }
    </script>

    <script id="fs-draw" type="x-shader/x-fragment">
        #version 300 es
        precision highp float;
        precision highp int;

        flat in vec4 vcolor;
        out vec4 color;

        void main()
        {
            color = vcolor;
        }
    </script>
    <script type='text/javascript' src='transformfeedbackcopy.js'></script>

  </body>
</html>

